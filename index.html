<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultimate Chess</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chess libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"/>

<style>
:root {
  --bg:#0e0e0e;
  --card:#1c1c1c;
  --text:#fff;
  --accent:#4caf50;
}
body.light {
  --bg:#f3f3f3;
  --card:#fff;
  --text:#000;
}
body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial, sans-serif;
  display:flex;
  justify-content:center;
}
.container {
  max-width:420px;
  width:100%;
  padding:12px;
}
h1 { text-align:center; }
#board { width:100%; }
.panel {
  background:var(--card);
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}
.timer {
  display:flex;
  justify-content:space-between;
  font-weight:bold;
}
button, select {
  width:100%;
  padding:10px;
  margin-top:6px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:white;
  font-size:15px;
}
select { background:#333; }
#moves {
  max-height:120px;
  overflow:auto;
  font-size:14px;
}
.highlight {
  background:radial-gradient(circle, rgba(0,255,0,.4) 40%, transparent 45%) !important;
}
</style>
</head>

<body>
<div class="container">

<h1>‚ôüÔ∏è Ultimate Chess</h1>

<div id="board"></div>

<div class="panel">
  <div class="timer">
    <span>White ‚è±Ô∏è <span id="wTime">05:00</span></span>
    <span>Black ‚è±Ô∏è <span id="bTime">05:00</span></span>
  </div>
  <p id="status"></p>
</div>

<div class="panel">
  <select id="level">
    <option value="5">ü§ñ Easy</option>
    <option value="10">ü§ñ Medium</option>
    <option value="15">ü§ñ Hard</option>
  </select>
  <button onclick="undoMove()">‚Ü©Ô∏è Undo</button>
  <button onclick="newGame()">üîÑ New Game</button>
  <button onclick="toggleTheme()">üåô Toggle Theme</button>
</div>

<div class="panel">
  <strong>Moves</strong>
  <div id="moves"></div>
</div>

<audio id="moveS" src="https://cdn.pixabay.com/audio/2022/03/15/audio_5c7fba9d3d.mp3"></audio>
<audio id="capS" src="https://cdn.pixabay.com/audio/2022/03/15/audio_1b9a76db5c.mp3"></audio>

</div>

<script>
let board, game, engine;
let timer=null, wSec=300, bSec=300;

const wTime=document.getElementById("wTime");
const bTime=document.getElementById("bTime");
const status=document.getElementById("status");
const movesDiv=document.getElementById("moves");

const moveS=document.getElementById("moveS");
const capS=document.getElementById("capS");

/* ---------------- TIMER ---------------- */
function startTimer(){
  stopTimer();
  timer=setInterval(()=>{
    game.turn()==='w'?wSec--:bSec--;
    wTime.textContent=format(wSec);
    bTime.textContent=format(bSec);
  },1000);
}
function stopTimer(){ if(timer){clearInterval(timer);timer=null;} }
function format(s){return Math.floor(s/60)+":"+String(s%60).padStart(2,"0");}

/* ---------------- ENGINE ---------------- */
function initEngine(){
  engine=new Worker("https://cdn.jsdelivr.net/npm/stockfish@16/stockfish.js");
  engine.postMessage("uci");
}
function aiMove(){
  engine.postMessage("position fen "+game.fen());
  engine.postMessage("go depth "+document.getElementById("level").value);
}
engineMessage = e=>{
  if(e.data.startsWith("bestmove")){
    const m=e.data.split(" ")[1];
    game.move({from:m.slice(0,2),to:m.slice(2,4),promotion:'q'});
    board.position(game.fen());
    update();
  }
}

/* ---------------- GAME ---------------- */
function onDragStart(s,p){
  if(game.game_over()) return false;
  if(game.turn()==='b' && p.startsWith('w')) return false;
  highlight(s);
}
function onDrop(s,t){
  clearHighlight();
  const m=game.move({from:s,to:t,promotion:'q'});
  if(!m) return "snapback";
  (m.captured?capS:moveS).play();
  update();
  setTimeout(aiMove,300);
}
function update(){
  board.position(game.fen());
  movesDiv.innerHTML=game.history().join("<br>");
  if(game.in_checkmate()) status.textContent="‚ôö Checkmate!";
  else if(game.in_check()) status.textContent="‚ö†Ô∏è Check!";
  else status.textContent=(game.turn()==='w'?"White":"Black")+" to move";
}

/* ---------------- HIGHLIGHT ---------------- */
function highlight(s){
  game.moves({square:s,verbose:true})
    .forEach(m=>{
      document.querySelector(`[data-square='${m.to}']`)?.classList.add("highlight");
    });
}
function clearHighlight(){
  document.querySelectorAll(".highlight").forEach(e=>e.classList.remove("highlight"));
}

/* ---------------- CONTROLS ---------------- */
function undoMove(){
  game.undo(); game.undo();
  update();
}
function newGame(){
  if(!confirm("Start a new game?")) return;
  stopTimer();
  board.destroy();
  game=new Chess();
  wSec=bSec=300;
  wTime.textContent=bTime.textContent="05:00";
  initBoard();
  update();
  startTimer();
}
function toggleTheme(){document.body.classList.toggle("light");}

/* ---------------- INIT ---------------- */
function initBoard(){
  board=Chessboard("board",{
    draggable:true,
    position:"start",
    onDragStart,
    onDrop,
    onSnapEnd:()=>board.position(game.fen())
  });
}
function init(){
  game=new Chess();
  initEngine();
  engine.onmessage=engineMessage;
  initBoard();
  update();
  startTimer();
}
init();
</script>
</body>
</html>
