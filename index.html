<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Chess</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"/>

<style>
:root {
  --bg:#0f0f0f;
  --card:#1c1c1c;
  --text:#fff;
  --accent:#4caf50;
}
body.light {
  --bg:#f3f3f3;
  --card:#fff;
  --text:#000;
}
body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
}
.container {
  max-width:420px;
  width:100%;
  padding:15px;
}
h1 { text-align:center; }
#board { width:100%; }
.panel {
  background:var(--card);
  padding:12px;
  border-radius:10px;
  margin-top:12px;
}
.timer {
  display:flex;
  justify-content:space-between;
  font-weight:bold;
}
button {
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:white;
  font-size:16px;
  cursor:pointer;
}
</style>
</head>

<body class="dark">
<div class="container">

<h1>‚ôüÔ∏è Chess</h1>
<div id="board"></div>

<div class="panel">
  <div class="timer">
    <span>White ‚è±Ô∏è <span id="whiteTime">05:00</span></span>
    <span>Black ‚è±Ô∏è <span id="blackTime">05:00</span></span>
  </div>
  <p id="status"></p>
</div>

<div class="panel">
  <button onclick="toggleTheme()">üåô Toggle Dark Mode</button>
  <button onclick="resetGame()">üîÑ New Game</button>
</div>

<audio id="moveSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_5c7fba9d3d.mp3"></audio>
<audio id="captureSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_1b9a76db5c.mp3"></audio>

</div>

<script>
let board;
let game;
let timer = null;

let whiteSeconds = 300;
let blackSeconds = 300;

const whiteTimeEl = document.getElementById("whiteTime");
const blackTimeEl = document.getElementById("blackTime");
const statusEl = document.getElementById("status");
const moveSound = document.getElementById("moveSound");
const captureSound = document.getElementById("captureSound");

/* ---------------- TIMER ---------------- */
function startTimer() {
  stopTimer();
  timer = setInterval(() => {
    if (game.turn() === 'w') whiteSeconds--;
    else blackSeconds--;

    whiteTimeEl.textContent = formatTime(whiteSeconds);
    blackTimeEl.textContent = formatTime(blackSeconds);

    if (whiteSeconds <= 0 || blackSeconds <= 0) {
      statusEl.textContent = "‚è±Ô∏è Time Over!";
      stopTimer();
    }
  }, 1000);
}

function stopTimer() {
  if (timer) {
    clearInterval(timer);
    timer = null;
  }
}

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${s.toString().padStart(2,"0")}`;
}

/* ---------------- CHESS ---------------- */
function onDragStart(source, piece) {
  if (game.game_over()) return false;
  if (game.turn() === 'b' && piece.startsWith('w')) return false;
}

function onDrop(source, target) {
  const move = game.move({
    from: source,
    to: target,
    promotion: 'q'
  });

  if (move === null) return 'snapback';

  (move.captured ? captureSound : moveSound).play();
  updateStatus();
  setTimeout(makeAIMove, 300);
}

function makeAIMove() {
  if (game.game_over()) return;
  const moves = game.moves();
  const move = moves[Math.floor(Math.random() * moves.length)];
  game.move(move);
  moveSound.play();
  board.position(game.fen());
  updateStatus();
}

function updateStatus() {
  if (game.in_checkmate()) {
    statusEl.textContent = "‚ôö Checkmate!";
    stopTimer();
  } else if (game.in_check()) {
    statusEl.textContent = "‚ö†Ô∏è Check!";
  } else {
    statusEl.textContent =
      (game.turn() === 'w' ? "White" : "Black") + "'s turn";
  }
}

/* ---------------- CONTROLS ---------------- */
function resetGame() {
  stopTimer();

  // üî• CRITICAL FIX
  board.destroy();     // destroy old board
  game = new Chess();  // fresh game

  whiteSeconds = 300;
  blackSeconds = 300;
  whiteTimeEl.textContent = "05:00";
  blackTimeEl.textContent = "05:00";

  initBoard();         // recreate board
  updateStatus();
  startTimer();
}

function toggleTheme() {
  document.body.classList.toggle("light");
}

/* ---------------- INIT ---------------- */
function initBoard() {
  board = Chessboard("board", {
    draggable: true,
    position: "start",
    onDragStart,
    onDrop,
    onSnapEnd: () => board.position(game.fen())
  });
}

function init() {
  game = new Chess();
  initBoard();
  updateStatus();
  startTimer();
}

init();
</script>

</body>
</html>
